<svelte:head>
<title>bookish.tech</title>
</svelte:head>
<div class='mw6 ph4-ns sans-serif center'>
  <div class='flex justify-between items-end'>
    <h1 class='f3 mt4 mb0'>Booky</h1>
    <a href='/help'>help</a>
  </div>
  <Form />
  
  {#if preloading}
    <div>Loading...</div>
  {/if}

  <div class='pv3'>
    <div class='br2 pa2 bg-light-yellow flex justify-between'>
      <span>Input: {id}</span>
    </div>
    <h3 class='mt4'>Equivalents</h3>
    <table class='table w-100 collapse ba br2 b--black-10 pv2 ph3'>
      <tbody>
        <tr class='striped--moon-gray'>
          <th class='pv2 ph3 tl f6 fw6 ttu'>Code</th>
          <th class='pv2 ph3 tl f6 fw6 ttu'>Value</th>
        </tr>
	{#each Object.entries(results) as [key, value]}
        <tr class='striped--moon-gray'>
          <td class='pv2 ph3'>{key}</td>
          <td class='pv2 ph3'>{value.join(", ")}</td>
        </tr>
	{/each}
      </tbody>
    </table>
    <h4 class='mt4'>Frontmatter</h4>
<pre>---
{Object.entries(results).map(([key, value]) => `${key}: "${value[0]}"`).join("\n")}
---</pre>
    <h4 class='mt4'>API Endpoint</h4>
    <p class='i'>This is the URL of the backend API request used to create this page:</p>
    <ul class='list lh-copy pa0'>
      <li><a href={url}>{url}</a></li>
    </ul>
    <h4 class='mt4'>Permalinks</h4>
    <ul class='list lh-copy pa0'>
      {#each permalinks as permalink}
        <li><a href={permalink}>{permalink}</a></li>
      {:else}
        <li>No permalinks found</li>
      {/each}
    </ul>

    <h4 class='mt4'>Log</h4>
    <pre class='overflow-x-auto f7 lh-copy'>{messages.join('\n')}</pre>
  </div>
</div>

<script>
  export default {
    components: {
      Form: '../components/Form.html'
    },
    preload({ params, query }) {
      const { id, type } = query;
      const host = process.env.NODE_ENV === 'production' ?
        'https://api.bookish.tech' :
        'http://localhost:3111';
      const url = `${host}/search?type=${type}&id=${id}`;
      return this.fetch(url)
        .then(r => r.json()).then(res => {
          return { url, results: res.results, messages: res.messages, permalinks: res.permalinks, id };
        }, () => {
          return { error: 'Not found' };
        });
    }
  };
</script>
